name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        Write-Host "Building QR Scanner executable..."
        
        if (Test-Path "qr_scanner.spec") {
          Write-Host "Using spec file for building..."
          pyinstaller qr_scanner.spec
        } else {
          Write-Host "Using command line parameters for building..."
          pyinstaller --onefile --console --name "QRScanner" --add-data "README.md;." --add-data "CAMERA_CONTROL_GUIDE.md;." qr_scanner_optimized.py
        }
        
        # åˆ›å»ºå‘å¸ƒåŒ…
        New-Item -ItemType Directory -Force -Path "release"
        Copy-Item "dist\QRScanner.exe" "release\"
        Copy-Item "README.md" "release\"
        Copy-Item "CAMERA_CONTROL_GUIDE.md" "release\"
        if (Test-Path "camera_config.json") {
          Copy-Item "camera_config.json" "release\"
        } else {
          Write-Host "camera_config.json not found, skipping..."
        }
        
        # åˆ›å»ºæ‰¹å¤„ç†å¯åŠ¨æ–‡ä»¶
        $startScript = @"
        @echo off
        echo === QR Scanner - Windowsç‰ˆæœ¬ ===
        echo å¯åŠ¨QRæ‰«æå™¨...
        QRScanner.exe ultra_hd
        pause
        "@
        $startScript | Out-File -FilePath "release\start_qr_scanner.bat" -Encoding ascii
        
        # åˆ›å»ºä¸åŒåˆ†è¾¨ç‡çš„å¯åŠ¨è„šæœ¬
        $start4k = "@echo off`necho === QR Scanner - 4Kæ¨¡å¼ ===`nQRScanner.exe ultra_hd`npause"
        $start4k | Out-File -FilePath "release\start_4k.bat" -Encoding ascii

        $start1080p = "@echo off`necho === QR Scanner - 1080pæ¨¡å¼ ===`nQRScanner.exe full_hd`npause"
        $start1080p | Out-File -FilePath "release\start_1080p.bat" -Encoding ascii

        $start720p = "@echo off`necho === QR Scanner - 720pæ¨¡å¼ ===`nQRScanner.exe high`npause"
        $start720p | Out-File -FilePath "release\start_720p.bat" -Encoding ascii
        
        # åˆ›å»ºå¸®åŠ©æ–‡ä»¶
        $helpText = @"
        QR Scanner - Windowså¯æ‰§è¡Œç‰ˆæœ¬

        === ä½¿ç”¨æ–¹æ³• ===
        1. åŒå‡» start_qr_scanner.bat å¯åŠ¨ç¨‹åºï¼ˆé»˜è®¤4Kæ¨¡å¼ï¼‰
        2. æˆ–é€‰æ‹©ç‰¹å®šåˆ†è¾¨ç‡ï¼š
           - start_4k.bat: 4Kæ¨¡å¼ï¼ˆ3840x2160ï¼‰
           - start_1080p.bat: 1080pæ¨¡å¼ï¼ˆ1920x1080ï¼‰
           - start_720p.bat: 720pæ¨¡å¼ï¼ˆ1280x720ï¼‰
        3. æˆ–ç›´æ¥è¿è¡Œ QRScanner.exe

        === æ”¯æŒçš„å‚æ•° ===
        - ultra_hd: 4Kæ¨¡å¼
        - full_hd: 1080pæ¨¡å¼
        - high: 720pæ¨¡å¼
        - medium: 480pæ¨¡å¼
        - low: 240pæ¨¡å¼

        === æŒ‰é”®æ§åˆ¶ ===
        - q: é€€å‡ºç¨‹åº
        - d: åˆ‡æ¢è°ƒè¯•æ¨¡å¼
        - r: è°ƒæ•´æ£€æµ‹åŒºåŸŸ
        - i: æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
        - h: æ˜¾ç¤ºæ€§èƒ½æç¤º
        - w: æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯

        === ç³»ç»Ÿè¦æ±‚ ===
        - Windows 10/11 (64ä½)
        - æ”¯æŒUSBæ‘„åƒå¤´æˆ–å†…ç½®æ‘„åƒå¤´
        - å»ºè®®4GBä»¥ä¸Šå†…å­˜

        è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ CAMERA_CONTROL_GUIDE.md
        "@
        $helpText | Out-File -FilePath "release\ä½¿ç”¨è¯´æ˜.txt" -Encoding utf8
      shell: pwsh
        
    - name: Create icon file (if not exists)
      run: |
        if (-not (Test-Path "icon.ico")) {
          Write-Host "Icon file not found, executable will use default icon"
        }
      shell: pwsh
        
    - name: Test executable
      run: |
        Write-Host "Testing executable..."
        try {
          $process = Start-Process "release\QRScanner.exe" -ArgumentList "--help" -Wait -PassThru -NoNewWindow -RedirectStandardError "nul"
          Write-Host "Executable test completed"
        } catch {
          Write-Host "Executable test completed (timeout or expected error)"
        }
      shell: pwsh
        
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path "release\*" -DestinationPath "QRScanner-Windows.zip"
      shell: pwsh
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: QRScanner-Windows
        path: |
          release/
          QRScanner-Windows.zip
        retention-days: 30
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # æå–æ ‡ç­¾å
        $tagName = $env:GITHUB_REF -replace 'refs/tags/', ''
        $releaseName = "QR Scanner $tagName"
        
        # åˆ›å»ºreleaseæè¿°
        $releaseBody = @"
        ## QR Scanner Windowsç‰ˆæœ¬
        
        ### ğŸ“¦ ä¸‹è½½
        - **QRScanner-Windows.zip**: å®Œæ•´Windowså¯æ‰§è¡ŒåŒ…
        
        ### ğŸš€ ä½¿ç”¨æ–¹æ³•
        1. ä¸‹è½½å¹¶è§£å‹ QRScanner-Windows.zip
        2. åŒå‡» ``start_qr_scanner.bat`` å¯åŠ¨ç¨‹åº
        3. æˆ–ç›´æ¥è¿è¡Œ ``QRScanner.exe``
        
        ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
        - æ”¯æŒ4Kåˆ†è¾¨ç‡QRç æ‰«æ
        - æ™ºèƒ½æ€§èƒ½ä¼˜åŒ–
        - OpenCV + pyzbaråŒé‡æ£€æµ‹
        - è‡ªé€‚åº”åŒºåŸŸæ£€æµ‹
        - å®æ—¶æ€§èƒ½ç›‘æ§
        
        ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
        - Windows 10/11 (64ä½)
        - æ”¯æŒUSBæ‘„åƒå¤´æˆ–å†…ç½®æ‘„åƒå¤´
        - å»ºè®®4GBä»¥ä¸Šå†…å­˜
        
        ### ğŸ® æ§åˆ¶æŒ‰é”®
        - ``q``: é€€å‡ºç¨‹åº
        - ``d``: åˆ‡æ¢è°ƒè¯•æ¨¡å¼
        - ``r``: è°ƒæ•´æ£€æµ‹åŒºåŸŸ
        - ``i``: æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
        - ``h``: æ˜¾ç¤ºæ€§èƒ½æç¤º
        
        è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒåŒ…å†…çš„æ–‡æ¡£ã€‚
        "@
        
        # ä½¿ç”¨GitHub CLIåˆ›å»ºrelease
        gh release create $tagName QRScanner-Windows.zip --title $releaseName --notes $releaseBody --latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh 