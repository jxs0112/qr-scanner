name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        # åˆ›å»ºæ‰“åŒ…è„šæœ¬
        echo "Building QR Scanner executable..."
        
        # å¦‚æœå­˜åœ¨specæ–‡ä»¶ï¼Œä½¿ç”¨specæ–‡ä»¶æ‰“åŒ…ï¼Œå¦åˆ™ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°
        if exist qr_scanner.spec (
          echo "Using spec file for building..."
          pyinstaller qr_scanner.spec
        ) else (
          echo "Using command line parameters for building..."
          pyinstaller --onefile --console --name "QRScanner" --add-data "README.md;." --add-data "CAMERA_CONTROL_GUIDE.md;." qr_scanner_optimized.py
        )
        
        # åˆ›å»ºå‘å¸ƒåŒ…
        mkdir release
        copy dist\QRScanner.exe release\
        copy README.md release\
        copy CAMERA_CONTROL_GUIDE.md release\
        copy camera_config.json release\ 2>nul || echo "camera_config.json not found, skipping..."
        
        # åˆ›å»ºæ‰¹å¤„ç†å¯åŠ¨æ–‡ä»¶
        echo @echo off > release\start_qr_scanner.bat
        echo echo === QR Scanner - Windowsç‰ˆæœ¬ === >> release\start_qr_scanner.bat
        echo echo å¯åŠ¨QRæ‰«æå™¨... >> release\start_qr_scanner.bat
        echo QRScanner.exe ultra_hd >> release\start_qr_scanner.bat
        echo pause >> release\start_qr_scanner.bat
        
        # åˆ›å»ºå¸®åŠ©æ–‡ä»¶
        echo QR Scanner - Windowså¯æ‰§è¡Œç‰ˆæœ¬ > release\ä½¿ç”¨è¯´æ˜.txt
        echo. >> release\ä½¿ç”¨è¯´æ˜.txt
        echo 1. åŒå‡» start_qr_scanner.bat å¯åŠ¨ç¨‹åº >> release\ä½¿ç”¨è¯´æ˜.txt
        echo 2. æˆ–ç›´æ¥è¿è¡Œ QRScanner.exe >> release\ä½¿ç”¨è¯´æ˜.txt
        echo 3. æ”¯æŒçš„å‚æ•°: >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - ultra_hd: 4Kæ¨¡å¼ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - full_hd: 1080pæ¨¡å¼ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - high: 720pæ¨¡å¼ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - medium: 480pæ¨¡å¼ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - low: 240pæ¨¡å¼ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo. >> release\ä½¿ç”¨è¯´æ˜.txt
        echo 4. æŒ‰é”®æ§åˆ¶: >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - q: é€€å‡ºç¨‹åº >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - d: åˆ‡æ¢è°ƒè¯•æ¨¡å¼ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - r: è°ƒæ•´æ£€æµ‹åŒºåŸŸ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - i: æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯ >> release\ä½¿ç”¨è¯´æ˜.txt
        echo    - h: æ˜¾ç¤ºæ€§èƒ½æç¤º >> release\ä½¿ç”¨è¯´æ˜.txt
        echo. >> release\ä½¿ç”¨è¯´æ˜.txt
        echo è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ CAMERA_CONTROL_GUIDE.md >> release\ä½¿ç”¨è¯´æ˜.txt
        
    - name: Create icon file (if not exists)
      run: |
        # å¦‚æœæ²¡æœ‰å›¾æ ‡æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾æ ‡æè¿°
        if not exist icon.ico (
          echo Icon file not found, executable will use default icon
        )
        
    - name: Test executable
      run: |
        # ç®€å•æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å¯ä»¥å¯åŠ¨
        echo Testing executable...
        timeout 5 release\QRScanner.exe --help 2>nul || echo "Executable test completed"
        
    - name: Create ZIP archive
      run: |
        # åˆ›å»ºZIPå‹ç¼©åŒ…
        powershell Compress-Archive -Path release\* -DestinationPath QRScanner-Windows.zip
        
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: QRScanner-Windows
        path: |
          release/
          QRScanner-Windows.zip
        retention-days: 30
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: QR Scanner ${{ github.ref }}
        body: |
          ## QR Scanner Windowsç‰ˆæœ¬
          
          ### ğŸ“¦ ä¸‹è½½
          - **QRScanner-Windows.zip**: å®Œæ•´Windowså¯æ‰§è¡ŒåŒ…
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ QRScanner-Windows.zip
          2. åŒå‡» `start_qr_scanner.bat` å¯åŠ¨ç¨‹åº
          3. æˆ–ç›´æ¥è¿è¡Œ `QRScanner.exe`
          
          ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
          - æ”¯æŒ4Kåˆ†è¾¨ç‡QRç æ‰«æ
          - æ™ºèƒ½æ€§èƒ½ä¼˜åŒ–
          - OpenCV + pyzbaråŒé‡æ£€æµ‹
          - è‡ªé€‚åº”åŒºåŸŸæ£€æµ‹
          - å®æ—¶æ€§èƒ½ç›‘æ§
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - æ”¯æŒUSBæ‘„åƒå¤´æˆ–å†…ç½®æ‘„åƒå¤´
          - å»ºè®®4GBä»¥ä¸Šå†…å­˜
          
          ### ğŸ® æ§åˆ¶æŒ‰é”®
          - `q`: é€€å‡ºç¨‹åº
          - `d`: åˆ‡æ¢è°ƒè¯•æ¨¡å¼
          - `r`: è°ƒæ•´æ£€æµ‹åŒºåŸŸ
          - `i`: æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
          - `h`: æ˜¾ç¤ºæ€§èƒ½æç¤º
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒåŒ…å†…çš„æ–‡æ¡£ã€‚
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./QRScanner-Windows.zip
        asset_name: QRScanner-Windows.zip
        asset_content_type: application/zip 